# Prompt para retomar el proyecto de ACTUAL BUDGET y la importacion de PDFs

> **Objetivo:** que Claude Code analice mi fork de Actual Budget y entregue una implementación completa para importar extractos en PDF (Santander España y Revolut España) usando mi agente Mastra ya funcional.

---

## Contexto del Repositorio

- **Base:** fork del proyecto open source [Actual Budget](https://github.com/actualbudget/actual)
- **Mi fork:** `sropero96/personal-finance-actual_SR`
- **Rama de trabajo:** `experimental/mastra-agents-revenge`
- **Guía interna del repo:** archivo `CLAUDE.md` (lineamientos de estilo, flujos y convenciones). **Léelo y respétalo**.
- **Status actual:** ya existe un agente montado con Mastra AI, probado en el playground con buenos resultados sobre PDFs de Santander y Revolut (España), que devuelve transacciones estructuradas.

---

## Qué Quiero que Hagas

1. **Auditar el repo** (frontend + backend + scripts + tipos) para entender el flujo de `import` de Actual:

   - Identificar componente UI de importación (drag & drop, file picker, validaciones)
   - Revisar cómo se parsean actualmente CSV/OFX/QIF
   - Ver cómo se transforman a entidades internas (`Transaction`, `Account`, `Payee`, `ImportRule`)
   - Entender integración de fuentes externas (si existe) y manejo de estado/progreso de import

2. **Diseñar e implementar soporte de PDF** manteniendo filosofía y arquitectura del proyecto:

   - **Frontend:** permitir subir `.pdf` además de formatos soportados
   - **Backend/worker:** enviar PDF al endpoint del agente Mastra, manejar timeouts y reintentos
   - **Mapping:** transformar la respuesta al formato exacto de import de Actual
   - **Idempotencia:** evitar duplicados con claves (fecha, importe, descripción normalizada, referencia bancaria)

3. **Generar to-do list técnica detallada** con entregables atómicos y PRs ordenados.

4. **Tests:** unitarios del mapper, validaciones PDF, y e2e del flujo de import.

5. **Documentación:** actualizar `CLAUDE.md` y/o `docs/` con:

   - Arquitectura del flujo pdf → Mastra → import
   - Variables de entorno y configuración
   - Instrucciones de dev/QA

---

## Especificaciones del Agente Mastra

- **Endpoint:** `${MASTRA_AGENT_URL}`
- **API key:** `${MASTRA_API_KEY}`
- **Contrato de entrada:** `POST /parse-pdf` con `multipart/form-data` o `application/pdf`
- **Contrato de salida esperado (ejemplo):**

```json
{
  "account": { "iban": "ES..", "currency": "EUR", "bank": "santander" },
  "statement": { "period_start": "2025-08-01", "period_end": "2025-08-31" },
  "transactions": [
    {
      "date": "2025-08-12",
      "value_date": "2025-08-12",
      "description": "AMAZON EU",
      "amount": -23.45,
      "currency": "EUR",
      "reference": "XYZ123",
      "category_hint": null
    }
  ]
}
```

---

## Requisitos Funcionales

- Bancos soportados v1: **Santander España** y **Revolut España**
- Soportar PDFs multipágina, encabezados/pies, totales
- Normalizar fechas a `yyyy-mm-dd`
- Moneda: `EUR`
- Deduplicación: estrategia nativa de Actual + `reference`
- Campos mínimos: fecha, descripción, importe, notas/ref, cuenta
- UI: feedback de progreso y errores

---

## Requisitos No Funcionales

- No romper importadores existentes (CSV/OFX/QIF)
- Código tipado (TS) y tests con buena cobertura
- Configurable por `.env`
- Feature flag `IMPORT_PDF_ENABLED`
- Manejo de archivos grandes (chunked upload si aplica)

---

## Guía de Implementación

1. Leer `CLAUDE.md` y seguir convenciones
2. Mapear flujo actual de import
3. Extender componente de import para aceptar `.pdf`
4. Crear cliente http `mastraClient.ts`
5. Implementar mapper `mapMastraToActual.ts`
6. Integrar en pipeline de import
7. Tests unitarios y e2e
8. Documentar en `docs/import-pdf.md`
9.  Abrir PRs pequeños y progresivos

---

## To‑Do List

-

---

## Prompt de Invocación al Agente Mastra (sugerido)

```text
objetivo: extraer el 100% de las transacciones bancarias de un extracto en pdf (santander españa o revolut españa) y devolverlas estructuradas.

requisitos:
- detectar banco y período automáticamente
- devolver account, statement, transactions[]
- fechas en yyyy-mm-dd
- débitos negativos, créditos positivos
- excluir cabeceras/pies, totales
- salida estricta en JSON
```

Mejorar el prompt como creas necesario para obtener la totalidad de las transacciones y en el formato mas eficiente a partir del AGENTE.

---

## Acceptance Criteria (DoD)

- Arrastrar un PDF al import y ver movimientos en la pantalla de revisión
- Importadores previos intactos
- Env vars y feature flag documentados
- Tests en CI pasando

---

## Performance

- Reintentos con backoff
- PDFs escaneados → error claro si OCR no soportado

---

## Estilo de Código

- Seguir reglas de `CLAUDE.md`
- Proponer cambios si contradicciones

---

## Variables a Completar

- `MASTRA_AGENT_URL=`
- `IMPORT_PDF_ENABLED=true`

