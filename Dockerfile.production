# ============================================
# Actual Budget + Claude AI PDF Importer
# Production Dockerfile for Fly.io
# ============================================

# Stage 1: Build
FROM node:20-bullseye AS builder

WORKDIR /app

# Install system dependencies
RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y openssl git && \
    rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package.json yarn.lock .yarnrc.yml ./
COPY .yarn ./.yarn
COPY packages/sync-server/package.json ./packages/sync-server/
COPY packages/loot-core/package.json ./packages/loot-core/
COPY packages/desktop-client/package.json ./packages/desktop-client/
COPY packages/crdt/package.json ./packages/crdt/
COPY packages/component-library/package.json ./packages/component-library/
COPY packages/api/package.json ./packages/api/
COPY anthropic-pdf-agent/package.json ./anthropic-pdf-agent/

# Install dependencies (allow lockfile updates for build)
RUN yarn install

# Copy source code
COPY . .

# Build browser application (loot-core + web client)
RUN export NODE_OPTIONS="--max-old-space-size=4096" && \
    yarn workspace loot-core build:browser && \
    yarn workspace @actual-app/web build:browser

# Build sync server
RUN yarn workspace @actual-app/sync-server build

# Install Anthropic Agent Server dependencies
RUN cd anthropic-pdf-agent && yarn install --production

# ============================================
# Stage 2: Production Runtime
FROM node:20-bullseye-slim

WORKDIR /app

# Install runtime dependencies
RUN apt-get update -y && \
    apt-get install -y openssl tini && \
    rm -rf /var/lib/apt/lists/*

# Copy built artifacts from builder
COPY --from=builder /app/packages/sync-server/build ./sync-server
COPY --from=builder /app/packages/desktop-client/build ./static
COPY --from=builder /app/packages/sync-server/node_modules ./sync-server/node_modules
COPY --from=builder /app/packages/sync-server/package.json ./sync-server/package.json

# Copy Anthropic Agent Server
COPY --from=builder /app/anthropic-pdf-agent ./anthropic-pdf-agent

# Create data directory
RUN mkdir -p /data && chmod 777 /data

# Create startup script
COPY <<'EOF' /app/start.sh
#!/bin/bash
set -e

echo "ðŸš€ Starting Actual Budget with Claude AI PDF Importer"

# Start Anthropic Agent Server in background
echo "ðŸ“¡ Starting Anthropic Agent Server on port 4000..."
cd /app/anthropic-pdf-agent
node server.js &
AGENT_PID=$!

# Wait for Agent Server to be ready
echo "â³ Waiting for Agent Server..."
sleep 3

# Start Actual Budget Sync Server
echo "ðŸ’° Starting Actual Budget Sync Server on port 5006..."
cd /app/sync-server
exec node app.js

# If sync server exits, kill agent server
trap "kill $AGENT_PID" EXIT
EOF

RUN chmod +x /app/start.sh

# Expose ports
EXPOSE 5006 4000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD node -e "require('http').get('http://localhost:5006/health', (r) => r.statusCode === 200 ? process.exit(0) : process.exit(1))"

# Use tini to handle signals properly
ENTRYPOINT ["/usr/bin/tini", "--"]

# Start both servers
CMD ["/app/start.sh"]
